---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
---

<Layout title="Submit a Job ‚Äî designjobs" description="Submit a healthcare UX job listing to the community-curated board.">
  <Header />

  <main id="main-content">
  <section class="w-full lg:w-[80%] xl:w-[70%] 2xl:w-[60%] mx-auto px-6 pt-12 pb-20">
    <div id="form-container" class="max-w-2xl mx-auto">
      <div class="mb-10 text-center">
        <h1 class="animate-fade-in stagger-1 text-3xl font-bold text-gray-900 dark:text-white mb-3">Submit a job</h1>
        <p class="animate-fade-in stagger-1 text-base text-gray-500 dark:text-gray-400">
          Know of a great healthcare UX role? Add it to the board. Every submission is reviewed before publishing.
        </p>
      </div>

      <form id="job-form" class="animate-fade-in stagger-2 space-y-6">
        <!-- Submitter Info -->
        <div class="bg-creme-100 dark:bg-gray-800/50 rounded-xl p-5 space-y-4">
          <p class="text-sm font-medium text-gray-700 dark:text-gray-300">Your information</p>
          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <label for="submitterName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Your Name <span class="text-red-400">*</span></label>
              <input
                type="text"
                id="submitterName"
                name="submitterName"
                required
                placeholder="Full name"
                class="form-input"
              />
            </div>
            <div>
              <label for="submitterEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Your Email <span class="text-red-400">*</span></label>
              <input
                type="email"
                id="submitterEmail"
                name="submitterEmail"
                required
                placeholder="you@company.com"
                class="form-input"
              />
            </div>
          </div>
          <p class="text-xs text-gray-400 dark:text-gray-500">Your info is never published ‚Äî it's only used for review and follow-up.</p>
        </div>

        <!-- Honeypot (hidden from humans) -->
        <div class="!absolute !opacity-0 !h-0 !overflow-hidden pointer-events-none" aria-hidden="true" tabindex="-1">
          <label for="website_url">Website</label>
          <input type="text" id="website_url" name="website_url" tabindex="-1" autocomplete="off" />
        </div>

        <!-- Job Title -->
        <div>
          <label for="title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Job Title <span class="text-red-400">*</span></label>
          <input
            type="text"
            id="title"
            name="title"
            required
            placeholder="e.g., Senior UX Designer"
            class="form-input"
          />
        </div>

        <!-- Company -->
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label for="company" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Company <span class="text-red-400">*</span></label>
            <input
              type="text"
              id="company"
              name="company"
              required
              placeholder="e.g., Oscar Health"
              class="form-input"
            />
          </div>
          <div>
            <label for="companyUrl" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Company Website <span class="text-red-400">*</span></label>
            <input
              type="url"
              id="companyUrl"
              name="companyUrl"
              required
              placeholder="https://company.com"
              class="form-input"
            />
          </div>
        </div>

        <!-- Job URL -->
        <div>
          <label for="url" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Job Posting URL <span class="text-red-400">*</span></label>
          <input
            type="url"
            id="url"
            name="url"
            required
            placeholder="https://company.com/careers/job-link"
            class="form-input"
          />
          <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Direct link to the active job listing</p>
        </div>

        <!-- Level + Location Type -->
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label for="level" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Level <span class="text-red-400">*</span></label>
            <select id="level" name="level" required class="form-input">
              <option value="">Select level</option>
              <option value="Junior">Junior</option>
              <option value="Mid">Mid</option>
              <option value="Senior">Senior</option>
              <option value="Staff">Staff</option>
              <option value="Lead">Lead</option>
              <option value="Principal">Principal</option>
              <option value="Director">Director</option>
            </select>
          </div>
          <div>
            <label for="locationType" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Location Type <span class="text-red-400">*</span></label>
            <select id="locationType" name="locationType" required class="form-input">
              <option value="">Select type</option>
              <option value="Remote">üåç Remote</option>
              <option value="Hybrid">üè¢ Hybrid</option>
              <option value="Onsite">üìç Onsite</option>
            </select>
          </div>
        </div>

        <!-- Location -->
        <div>
          <label for="location" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Location <span class="text-red-400">*</span></label>
          <input
            type="text"
            id="location"
            name="location"
            required
            placeholder="e.g., San Francisco, CA or USA"
            class="form-input"
          />
        </div>

        <!-- Tags -->
        <div>
          <label for="tags" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Tags</label>
          <input
            type="text"
            id="tags"
            name="tags"
            placeholder="e.g., telehealth, mental health, B2C"
            class="form-input"
          />
          <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Comma-separated. Helps people find relevant roles.</p>
        </div>

        <!-- Verification -->
        <div class="bg-creme-100 dark:bg-gray-800/50 rounded-xl p-5 space-y-3">
          <p class="text-sm font-medium text-gray-700 dark:text-gray-300">Before submitting, please confirm:</p>
          <label class="flex items-start gap-3 cursor-pointer">
            <input type="checkbox" name="confirm_direct" required class="mt-0.5 rounded border-gray-300 dark:border-gray-600 text-sapphire-500 focus:ring-sapphire-500" />
            <span class="text-sm text-gray-600 dark:text-gray-400">This is a direct company listing (not a recruiter/staffing agency)</span>
          </label>
          <label class="flex items-start gap-3 cursor-pointer">
            <input type="checkbox" name="confirm_active" required class="mt-0.5 rounded border-gray-300 dark:border-gray-600 text-sapphire-500 focus:ring-sapphire-500" />
            <span class="text-sm text-gray-600 dark:text-gray-400">The job posting is currently active</span>
          </label>
          <label class="flex items-start gap-3 cursor-pointer">
            <input type="checkbox" name="confirm_healthcare" required class="mt-0.5 rounded border-gray-300 dark:border-gray-600 text-sapphire-500 focus:ring-sapphire-500" />
            <span class="text-sm text-gray-600 dark:text-gray-400">This is a UX/design role at a healthcare or health-tech company</span>
          </label>
          <label class="flex items-start gap-3 cursor-pointer">
            <input type="checkbox" name="confirm_real" required class="mt-0.5 rounded border-gray-300 dark:border-gray-600 text-sapphire-500 focus:ring-sapphire-500" />
            <span class="text-sm text-gray-600 dark:text-gray-400">This is a real job posting, not spam or a test submission</span>
          </label>
        </div>

        <!-- Cloudflare Turnstile widget -->
        <div id="turnstile-container"></div>
        <input type="hidden" id="turnstile-token" name="turnstile-token" value="" />

        <!-- Error messages (hidden by default) -->
        <div id="error-msg" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4 text-sm text-red-600 dark:text-red-400"></div>

        <div id="rate-limit-msg" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4 text-sm text-red-600 dark:text-red-400">
          You've reached the maximum of 5 submissions per 24 hours for this email. Please try again later.
        </div>

        <!-- Submit -->
        <button
          type="submit"
          id="submit-btn"
          class="w-full py-3 bg-sapphire-500 text-white font-semibold rounded-full hover:bg-sapphire-600 transition-colors text-sm"
        >
          Submit for review
        </button>

        <p class="text-xs text-center text-gray-400 dark:text-gray-500">
          Submissions are reviewed by maintainers before being published.
        </p>
      </form>

    </div>

    <!-- Success state ‚Äî replaces entire form container -->
    <div id="success-msg" class="hidden max-w-lg mx-auto text-center py-24">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-green-50 dark:bg-green-900/30 mb-6">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 6 9 17l-5-5" />
        </svg>
      </div>
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-3">Submitted!</h2>
      <p class="text-gray-500 dark:text-gray-400 mb-8 leading-relaxed">Your listing has been submitted for review. We'll add it to the board once approved.</p>
      <div class="flex flex-col sm:flex-row justify-center gap-3">
        <a href="/jobs" class="px-6 py-3 bg-sapphire-500 text-white font-semibold rounded-full hover:bg-sapphire-600 transition-colors text-sm">
          Browse jobs
        </a>
        <a href="/submit" class="px-6 py-3 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 font-semibold rounded-full hover:border-sapphire-200 hover:text-sapphire-500 transition-[color,border-color] duration-150 text-sm">
          Submit another
        </a>
      </div>
    </div>
  </section>
  </main>

  <Footer />
</Layout>

<style>
  .form-input {
    width: 100%;
    padding: 0.625rem 0.875rem;
    border-radius: 0.75rem;
    border: 1px solid #e5e7eb;
    background: white;
    font-size: 0.875rem;
    color: #111827;
    transition: border-color 0.15s ease, box-shadow 0.15s ease;
  }
  .form-input:focus {
    outline: none;
    border-color: #7EA2E1;
    box-shadow: 0 0 0 3px rgba(15, 82, 186, 0.1);
  }
  .form-input::placeholder {
    color: #9ca3af;
  }
  :global(.dark) .form-input {
    background: #111827;
    border-color: #374151;
    color: #f3f4f6;
  }
  :global(.dark) .form-input::placeholder {
    color: #6b7280;
  }
  :global(.dark) .form-input:focus {
    border-color: #5383D7;
    box-shadow: 0 0 0 3px rgba(15, 82, 186, 0.2);
  }
  select.form-input {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    padding-right: 2.5rem;
  }
</style>

<script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=onTurnstileLoad" async defer></script>

<script is:inline>
  function onTurnstileLoad() {
    turnstile.render('#turnstile-container', {
      sitekey: '0x4AAAAAACckLBTY6z74gBae',
      theme: 'auto',
      callback: function(token) {
        document.getElementById('turnstile-token').value = token;
      },
    });
  }
</script>

<script>
  const form = document.getElementById('job-form') as HTMLFormElement;
  const formContainer = document.getElementById('form-container');
  const successMsg = document.getElementById('success-msg');
  const rateLimitMsg = document.getElementById('rate-limit-msg');
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const errorMsg = document.getElementById('error-msg');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Disable button, show loading
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    submitBtn.classList.add('opacity-75');

    const data = new FormData(form);

    // Get Turnstile token
    const turnstileToken = (document.getElementById('turnstile-token') as HTMLInputElement)?.value || (document.querySelector('[name="cf-turnstile-response"]') as HTMLInputElement)?.value || '';

    const payload: Record<string, string> = {
      submitterName: data.get('submitterName') as string,
      submitterEmail: data.get('submitterEmail') as string,
      title: data.get('title') as string,
      company: data.get('company') as string,
      companyUrl: data.get('companyUrl') as string,
      url: data.get('url') as string,
      level: data.get('level') as string,
      locationType: data.get('locationType') as string,
      location: data.get('location') as string,
      tags: data.get('tags') as string || '',
      website_url: data.get('website_url') as string || '',
      turnstileToken,
    };

    try {
      const res = await fetch('/api/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      const result = await res.json() as { ok: boolean; error?: string };

      if (result.ok) {
        formContainer?.classList.add('hidden');
        successMsg?.classList.remove('hidden');
      } else if (res.status === 429) {
        rateLimitMsg?.classList.remove('hidden');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Limit reached';
        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        // Show error
        if (errorMsg) {
          errorMsg.textContent = result.error || 'Something went wrong. Please try again.';
          errorMsg.classList.remove('hidden');
        }
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit for review';
        submitBtn.classList.remove('opacity-75');
        // Reset Turnstile
        if (window.turnstile) window.turnstile.reset();
      }
    } catch (err) {
      if (errorMsg) {
        errorMsg.textContent = 'Network error. Please check your connection and try again.';
        errorMsg.classList.remove('hidden');
      }
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit for review';
      submitBtn.classList.remove('opacity-75');
    }
  });
</script>
