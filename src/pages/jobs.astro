---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import JobCard from '../components/JobCard.astro';
import Newsletter from '../components/Newsletter.astro';
import jobs from '../data/jobs.json';

const levelOrder = ['Mid', 'Senior', 'Staff', 'Lead', 'Principal', 'Director'];
const levels = levelOrder.filter(l => jobs.some(j => j.level === l));
const locationTypes = [...new Set(jobs.map(j => j.locationType))];
const locations = [...new Set(jobs.map(j => j.location))].sort();

const levelCounts: Record<string, number> = {};
levels.forEach(l => { levelCounts[l] = jobs.filter(j => j.level === l).length; });
const locationCounts: Record<string, number> = {};
locationTypes.forEach(lt => { locationCounts[lt] = jobs.filter(j => j.locationType === lt).length; });
---

<Layout title="All Jobs ‚Äî designjobs" description={`${jobs.length} healthcare UX jobs from companies that care. Browse product designer, UX designer, and UX researcher roles at health-tech companies.`}>
  <Header />

  <!-- JSON-LD: JobPosting structured data for search engines -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "ItemList",
    "name": "Healthcare UX Jobs",
    "description": `${jobs.length} healthcare UX design roles from companies that care`,
    "numberOfItems": jobs.length,
    "itemListElement": jobs.slice(0, 50).map((job, i) => ({
      "@type": "ListItem",
      "position": i + 1,
      "item": {
        "@type": "JobPosting",
        "title": job.title,
        "datePosted": job.postedDate,
        "hiringOrganization": {
          "@type": "Organization",
          "name": job.company,
          "sameAs": job.companyUrl
        },
        "jobLocation": {
          "@type": "Place",
          "address": job.locationType === 'Remote' ? { "@type": "PostalAddress", "addressCountry": "US" } : { "@type": "PostalAddress", "addressLocality": job.location }
        },
        "jobLocationType": job.locationType === 'Remote' ? "TELECOMMUTE" : undefined,
        "url": job.url,
        "employmentType": "FULL_TIME"
      }
    }))
  })} />

  <section class="w-full lg:w-[80%] xl:w-[70%] 2xl:w-[60%] mx-auto px-6 pt-12 pb-6">
    <h1 class="animate-fade-in stagger-1 text-3xl font-bold text-gray-900 dark:text-white mb-2">All jobs</h1>
    <p class="animate-fade-in stagger-1 text-base text-gray-500 dark:text-gray-400"><span id="visible-count">{jobs.length}</span> healthcare UX roles from companies that care</p>
  </section>

  <!-- Search & Location -->
  <section class="w-full lg:w-[80%] xl:w-[70%] 2xl:w-[60%] mx-auto px-6 pb-4">
    <div class="animate-fade-in stagger-2 flex flex-col sm:flex-row gap-3 max-w-2xl">
      <div class="relative flex-1">
        <svg class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" />
        </svg>
        <input
          id="search-input"
          type="search"
          aria-label="Search jobs by title, company, location, or tag"
          placeholder="Search by title, company, location, or tag..."
          class="w-full pl-11 pr-4 py-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:border-sapphire-300 dark:focus:border-sapphire-700 focus:ring-2 focus:ring-sapphire-100 dark:focus:ring-sapphire-900/50 transition-[border-color,box-shadow] duration-150"
        />
      </div>
      <div class="relative sm:w-48">
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" /><circle cx="12" cy="10" r="3" />
        </svg>
        <select
          id="location-select"
          aria-label="Filter by location"
          class="w-full appearance-none pl-9 pr-8 py-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm text-gray-900 dark:text-gray-100 focus:outline-none focus:border-sapphire-300 dark:focus:border-sapphire-700 focus:ring-2 focus:ring-sapphire-100 dark:focus:ring-sapphire-900/50 transition-[border-color,box-shadow] duration-150 cursor-pointer"
        >
          <option value="">All locations</option>
          {locations.map(loc => (
            <option value={loc}>{loc}</option>
          ))}
        </select>
        <svg class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <path d="m6 9 6 6 6-6" />
        </svg>
      </div>
    </div>
  </section>

  <!-- Filters -->
  <section class="w-full lg:w-[80%] xl:w-[70%] 2xl:w-[60%] mx-auto px-6 pb-8">
    <div class="animate-fade-in stagger-2 flex flex-wrap gap-2" id="filters">
      <button class="filter-btn active" data-filter="all">
        All <span class="filter-count">{jobs.length}</span>
      </button>
      {levels.map(level => (
        <button class="filter-btn" data-filter={`level:${level}`}>
          {level} <span class="filter-count">{levelCounts[level]}</span>
        </button>
      ))}
      <span class="border-l border-gray-200 mx-1 hidden sm:block"></span>
      {locationTypes.map(lt => (
        <button class="filter-btn" data-filter={`location:${lt}`}>
          {lt === 'Remote' ? 'üåç ' : lt === 'Hybrid' ? 'üè¢ ' : 'üìç '}{lt} <span class="filter-count">{locationCounts[lt]}</span>
        </button>
      ))}
    </div>
  </section>

  <!-- Jobs List -->
  <section class="w-full lg:w-[80%] xl:w-[70%] 2xl:w-[60%] mx-auto px-6 pb-20">
    <div class="grid gap-3" id="jobs-list" role="list" aria-label="Job listings">
      {jobs.map((job, i) => (
        <div
          role="listitem"
          class="job-item reveal"
          data-delay={String(Math.min(i * 30, 300))}
          data-level={job.level}
          data-location-type={job.locationType}
          data-location={job.location}
          data-search={`${job.title} ${job.company} ${job.location} ${job.tags.join(' ')}`.toLowerCase()}
        >
          <JobCard {...job} />
        </div>
      ))}
    </div>
    <p id="no-results" class="text-center text-gray-400 py-12 hidden">
      No jobs match your search. Try different keywords or filters!
    </p>
  </section>

  <!-- Newsletter -->
  <section class="w-full lg:w-[80%] xl:w-[70%] 2xl:w-[60%] mx-auto px-6 pb-10">
    <Newsletter />
  </section>

  <Footer />
</Layout>

<style>
  .filter-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 500;
    border: 1px solid #e5e7eb;
    color: #6b7280;
    background: white;
    transition: background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease;
    cursor: pointer;
  }
  :global(.dark) .filter-btn {
    border-color: #374151;
    color: #9ca3af;
    background: #111827;
  }
  .filter-btn:hover {
    border-color: #D4E0F5;
    color: #0F52BA;
  }
  :global(.dark) .filter-btn:hover {
    border-color: #1e3a5f;
  }
  .filter-btn.active {
    background: #0F52BA;
    border-color: #0F52BA;
    color: white;
  }
  .filter-count {
    font-size: 0.75rem;
    opacity: 0.7;
  }
</style>

<script>
  const buttons = document.querySelectorAll('.filter-btn');
  const items = document.querySelectorAll('.job-item');
  const noResults = document.getElementById('no-results');
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const locationSelect = document.getElementById('location-select') as HTMLSelectElement;
  const visibleCount = document.getElementById('visible-count');

  let activeFilter = 'all';
  let searchQuery = '';
  let activeLocation = '';

  function applyFilters() {
    let visible = 0;
    items.forEach(item => {
      const el = item as HTMLElement;
      let show = true;

      // Level / location type filter
      if (activeFilter !== 'all') {
        if (activeFilter.startsWith('level:')) {
          show = el.dataset.level === activeFilter.split(':')[1];
        } else if (activeFilter.startsWith('location:')) {
          show = el.dataset.locationType === activeFilter.split(':')[1];
        }
      }

      // Location dropdown
      if (show && activeLocation) {
        show = el.dataset.location === activeLocation;
      }

      // Search
      if (show && searchQuery) {
        show = (el.dataset.search || '').includes(searchQuery);
      }

      el.style.display = show ? '' : 'none';
      if (show) visible++;
    });

    if (noResults) {
      noResults.classList.toggle('hidden', visible > 0);
    }
    if (visibleCount) {
      visibleCount.textContent = String(visible);
    }
  }

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      buttons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      activeFilter = btn.getAttribute('data-filter') || 'all';
      applyFilters();
    });
  });

  searchInput?.addEventListener('input', () => {
    searchQuery = searchInput.value.toLowerCase().trim();
    applyFilters();
  });

  locationSelect?.addEventListener('change', () => {
    activeLocation = locationSelect.value;
    applyFilters();
  });
</script>
