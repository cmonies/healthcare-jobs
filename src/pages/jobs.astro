---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import JobTable from '../components/JobTable.astro';
import Newsletter from '../components/Newsletter.astro';
import jobs from '../data/jobs.json';

const levelOrder = ['Mid', 'Senior', 'Staff', 'Lead', 'Principal', 'Director'];
const levels = levelOrder.filter(l => jobs.some(j => j.level === l));
const locationTypes = [...new Set(jobs.map(j => j.locationType))];
const locations = [...new Set(jobs.map(j => j.location))].sort();

const levelCounts: Record<string, number> = {};
levels.forEach(l => { levelCounts[l] = jobs.filter(j => j.level === l).length; });
const locationCounts: Record<string, number> = {};
locationTypes.forEach(lt => { locationCounts[lt] = jobs.filter(j => j.locationType === lt).length; });
---

<Layout title="All Jobs ‚Äî designjobs" description={`${jobs.length} healthcare UX jobs from companies that care. Browse product designer, UX designer, and UX researcher roles at health-tech companies.`}>
  <Header />

  <main id="main-content">

  <!-- JSON-LD: JobPosting structured data for search engines -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "ItemList",
    "name": "Healthcare UX Jobs",
    "description": `${jobs.length} healthcare UX design roles from companies that care`,
    "numberOfItems": jobs.length,
    "itemListElement": jobs.slice(0, 50).map((job, i) => ({
      "@type": "ListItem",
      "position": i + 1,
      "item": {
        "@type": "JobPosting",
        "title": job.title,
        "datePosted": job.postedDate,
        "hiringOrganization": {
          "@type": "Organization",
          "name": job.company,
          "sameAs": job.companyUrl
        },
        "jobLocation": {
          "@type": "Place",
          "address": job.locationType === 'Remote' ? { "@type": "PostalAddress", "addressCountry": "US" } : { "@type": "PostalAddress", "addressLocality": job.location }
        },
        "jobLocationType": job.locationType === 'Remote' ? "TELECOMMUTE" : undefined,
        "url": job.url,
        "employmentType": "FULL_TIME"
      }
    }))
  })} />

  <section class="w-full lg:w-[80%] xl:w-[70%] 2xl:w-[60%] mx-auto px-6 pt-12 pb-6">
    <h1 class="animate-fade-in stagger-1 text-3xl font-bold text-slate-900 dark:text-white mb-2">All jobs</h1>
    <p class="animate-fade-in stagger-1 text-base text-slate-500 dark:text-slate-400"><span id="visible-count">{jobs.length}</span> healthcare UX roles from companies that care</p>
  </section>

  <!-- Search, Location & Filters -->
  <section class="w-full lg:w-[80%] xl:w-[70%] 2xl:w-[60%] mx-auto px-6 pb-4 relative z-10" role="search" aria-label="Search and filter jobs">
    <div class="animate-fade-in stagger-2 flex flex-col sm:flex-row gap-3">
      <!-- Search -->
      <div class="relative flex-1">
        <svg class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" />
        </svg>
        <input
          id="search-input"
          type="text"
          aria-label="Search jobs by title, company, location, or tag"
          placeholder="Search by title, company, or tag..."
          class="w-full pl-11 pr-10 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-card text-sm text-slate-900 dark:text-slate-100 placeholder-slate-400 dark:placeholder-slate-500 focus:outline-none focus:border-brand-300 dark:focus:border-brand-700 focus:ring-2 focus:ring-brand-100 dark:focus:ring-brand-900/50 transition-[border-color,box-shadow] duration-150"
        />
        <button id="search-clear" class="hidden absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors" aria-label="Clear search">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 6 6 18" /><path d="m6 6 12 12" />
          </svg>
        </button>
      </div>

      <!-- Location dropdown -->
      <div class="relative sm:w-48">
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" /><circle cx="12" cy="10" r="3" />
        </svg>
        <select
          id="location-select"
          aria-label="Filter by location"
          class="w-full appearance-none pl-9 pr-8 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-card text-sm text-slate-900 dark:text-slate-100 focus:outline-none focus:border-brand-300 dark:focus:border-brand-700 focus:ring-2 focus:ring-brand-100 dark:focus:ring-brand-900/50 transition-[border-color,box-shadow] duration-150 cursor-pointer"
        >
          <option value="">All locations</option>
          {locations.map(loc => (
            <option value={loc}>{loc}</option>
          ))}
        </select>
        <svg class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <path d="m6 9 6 6 6-6" />
        </svg>
      </div>

      <!-- Filters dropdown trigger -->
      <div class="relative" id="filter-dropdown-wrapper">
        <button
          id="filter-btn"
          aria-expanded="false"
          aria-controls="filter-dropdown"
          class="flex items-center gap-2 px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-card text-sm font-medium text-slate-600 dark:text-slate-300 hover:border-brand-300 dark:hover:border-brand-700 transition-[border-color] duration-150 cursor-pointer whitespace-nowrap"
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <line x1="4" y1="6" x2="20" y2="6" /><line x1="8" y1="12" x2="16" y2="12" /><line x1="11" y1="18" x2="13" y2="18" />
          </svg>
          Filters
          <span id="filter-badge" class="hidden text-xs bg-brand-500 text-white rounded-full w-5 h-5 inline-flex items-center justify-center font-semibold">0</span>
        </button>

        <!-- Dropdown panel -->
        <div
          id="filter-dropdown"
          class="hidden absolute right-0 top-full mt-2 w-72 bg-white dark:bg-surface-card border border-slate-200 dark:border-slate-700 rounded-2xl shadow-soft-lg z-50 overflow-hidden"
        >
          <div class="p-4 space-y-4">
            <!-- Level section -->
            <div>
              <p class="text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2">Level</p>
              <div class="space-y-1.5">
                {levels.map(level => (
                  <label class="flex items-center gap-3 cursor-pointer py-1 px-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                    <input type="checkbox" class="filter-checkbox rounded border-slate-300 dark:border-slate-600 text-brand-500 focus:ring-brand-500" data-type="level" data-value={level} />
                    <span class="text-sm text-slate-700 dark:text-slate-300 flex-1">{level}</span>
                    <span class="text-xs text-slate-400 dark:text-slate-500">{levelCounts[level]}</span>
                  </label>
                ))}
              </div>
            </div>

            <!-- Location Type section -->
            <div class="border-t border-slate-100 dark:border-slate-700/50 pt-4">
              <p class="text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2">Work type</p>
              <div class="space-y-1.5">
                {locationTypes.map(lt => (
                  <label class="flex items-center gap-3 cursor-pointer py-1 px-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                    <input type="checkbox" class="filter-checkbox rounded border-slate-300 dark:border-slate-600 text-brand-500 focus:ring-brand-500" data-type="locationType" data-value={lt} />
                    <span class="text-sm text-slate-700 dark:text-slate-300 flex-1">
                      {lt === 'Remote' ? 'üåç ' : lt === 'Hybrid' ? 'üè¢ ' : 'üìç '}{lt}
                    </span>
                    <span class="text-xs text-slate-400 dark:text-slate-500">{locationCounts[lt]}</span>
                  </label>
                ))}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Active filter pills (shown when filters selected) -->
    <div id="active-filters" class="hidden flex flex-wrap items-center gap-2 mt-3">
      <span class="text-xs text-slate-400 dark:text-slate-500">Filtered by:</span>
      <div id="active-pills" class="flex flex-wrap gap-1.5"></div>
      <button id="clear-filters" class="text-xs text-brand-500 hover:text-brand-600 font-medium ml-1 transition-colors">Clear all</button>
    </div>
  </section>

  <!-- Jobs List -->
  <section class="w-full lg:w-[80%] xl:w-[70%] 2xl:w-[60%] mx-auto px-6 pb-20">
    <JobTable jobs={jobs} filterable id="jobs-list" delayStep={30} />
    <div id="no-results" class="text-center py-12 hidden">
      <p class="text-slate-400 mb-4">No jobs match your current filters.</p>
      <button id="clear-all-filters" class="px-5 py-2.5 text-sm font-medium text-slate-600 dark:text-slate-300 bg-transparent border border-slate-200 dark:border-slate-700 rounded-2xl hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
        Clear all filters
      </button>
    </div>
  </section>

  <!-- Newsletter -->
  <section class="w-full lg:w-[80%] xl:w-[70%] 2xl:w-[60%] mx-auto px-6 pb-10">
    <Newsletter />
  </section>

  </main>

  <Footer />
</Layout>

<style is:global>
  .job-row:last-child,
  .job-row.last-visible {
    border-bottom: none !important;
  }
  .filter-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.3rem 0.5rem 0.3rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.8125rem;
    font-weight: 500;
    border: 1px solid #E7E5E4;
    background: white;
    color: #3F3F46;
    cursor: pointer;
    transition: border-color 0.15s ease, background-color 0.15s ease;
    white-space: nowrap;
  }
  .filter-pill:hover {
    border-color: #B3BCFD;
    background: #EEF0FE;
  }
  .dark .filter-pill {
    border-color: #232326;
    background: #1A1A1B;
    color: #A1A1AA;
  }
  .dark .filter-pill:hover {
    border-color: #5872FA;
    background: #18181B;
  }
  .filter-pill .pill-x {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1rem;
    height: 1rem;
    border-radius: 9999px;
    background: #E7E5E4;
    color: #71717A;
    font-size: 0.625rem;
    line-height: 1;
    transition: background-color 0.15s ease, color 0.15s ease;
  }
  .filter-pill:hover .pill-x {
    background: #244BF8;
    color: white;
  }
  .dark .filter-pill .pill-x {
    background: #232326;
    color: #A1A1AA;
  }
  .dark .filter-pill:hover .pill-x {
    background: #244BF8;
    color: white;
  }
</style>

<script>
  const items = document.querySelectorAll('.job-item');
  const noResults = document.getElementById('no-results');
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const searchClear = document.getElementById('search-clear');
  const locationSelect = document.getElementById('location-select') as HTMLSelectElement;
  const visibleCount = document.getElementById('visible-count');
  const filterBtn = document.getElementById('filter-btn');
  const filterDropdown = document.getElementById('filter-dropdown');
  const filterBadge = document.getElementById('filter-badge');
  const activeFiltersContainer = document.getElementById('active-filters');
  const activePills = document.getElementById('active-pills');
  const clearFilters = document.getElementById('clear-filters');
  const checkboxes = document.querySelectorAll('.filter-checkbox') as NodeListOf<HTMLInputElement>;

  // Restore saved filters
  const saved = JSON.parse(localStorage.getItem('dj-filters') || '{}');
  let searchQuery = saved.search || '';
  let activeLocation = saved.location || '';
  let activeLevels: Set<string> = new Set(saved.levels || []);
  let activeLocationTypes: Set<string> = new Set(saved.locationTypes || []);

  function saveFilters() {
    localStorage.setItem('dj-filters', JSON.stringify({
      search: searchQuery,
      location: activeLocation,
      levels: [...activeLevels],
      locationTypes: [...activeLocationTypes],
    }));
  }

  // Restore UI state from saved filters
  if (searchInput && searchQuery) { searchInput.value = searchQuery; searchClear?.classList.remove('hidden'); }
  if (locationSelect && activeLocation) locationSelect.value = activeLocation;
  checkboxes.forEach(cb => {
    const type = cb.dataset.type;
    const value = cb.dataset.value || '';
    if (type === 'level' && activeLevels.has(value)) cb.checked = true;
    if (type === 'locationType' && activeLocationTypes.has(value)) cb.checked = true;
  });
  // Apply restored filters on load
  if (searchQuery || activeLocation || activeLevels.size || activeLocationTypes.size) {
    requestAnimationFrame(() => { updatePills(); applyFilters(); });
  }

  // Toggle dropdown
  filterBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    const open = filterDropdown?.classList.contains('hidden');
    filterDropdown?.classList.toggle('hidden');
    filterBtn?.setAttribute('aria-expanded', String(open));
  });

  // Close dropdown on outside click
  document.addEventListener('click', (e) => {
    const wrapper = document.getElementById('filter-dropdown-wrapper');
    if (wrapper && !wrapper.contains(e.target as Node)) {
      filterDropdown?.classList.add('hidden');
      filterBtn?.setAttribute('aria-expanded', 'false');
    }
  });

  // Close on Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      filterDropdown?.classList.add('hidden');
      filterBtn?.setAttribute('aria-expanded', 'false');
    }
  });

  // Checkbox change
  checkboxes.forEach(cb => {
    cb.addEventListener('change', () => {
      const type = cb.dataset.type;
      const value = cb.dataset.value || '';
      if (type === 'level') {
        cb.checked ? activeLevels.add(value) : activeLevels.delete(value);
      } else if (type === 'locationType') {
        cb.checked ? activeLocationTypes.add(value) : activeLocationTypes.delete(value);
      }
      updatePills();
      applyFilters();
      saveFilters();
    });
  });

  // Clear all
  clearFilters?.addEventListener('click', () => {
    activeLevels.clear();
    activeLocationTypes.clear();
    checkboxes.forEach(cb => cb.checked = false);
    updatePills();
    applyFilters();
    saveFilters();
  });

  function updatePills() {
    if (!activePills || !activeFiltersContainer || !filterBadge) return;

    const totalFilters = activeLevels.size + activeLocationTypes.size;
    activePills.innerHTML = '';

    // Show/hide the active filters bar
    activeFiltersContainer.classList.toggle('hidden', totalFilters === 0);

    // Update badge
    if (totalFilters > 0) {
      filterBadge.textContent = String(totalFilters);
      filterBadge.classList.remove('hidden');
    } else {
      filterBadge.classList.add('hidden');
    }

    // Create pills
    const createPill = (label: string, type: string, value: string) => {
      const pill = document.createElement('button');
      pill.className = 'filter-pill';
      pill.innerHTML = `${label}<span class="pill-x">‚úï</span>`;
      pill.addEventListener('click', () => {
        if (type === 'level') activeLevels.delete(value);
        else activeLocationTypes.delete(value);
        // Uncheck the corresponding checkbox
        checkboxes.forEach(cb => {
          if (cb.dataset.type === type && cb.dataset.value === value) cb.checked = false;
        });
        updatePills();
        applyFilters();
        saveFilters();
      });
      return pill;
    };

    activeLevels.forEach(v => activePills.appendChild(createPill(v, 'level', v)));
    activeLocationTypes.forEach(v => {
      const icon = v === 'Remote' ? 'üåç ' : v === 'Hybrid' ? 'üè¢ ' : 'üìç ';
      activePills.appendChild(createPill(icon + v, 'locationType', v));
    });
  }

  function applyFilters() {
    let visible = 0;
    let lastVisible: HTMLElement | null = null;
    items.forEach(item => {
      const el = item as HTMLElement;
      let show = true;

      // Level multi-select
      if (activeLevels.size > 0) {
        show = activeLevels.has(el.dataset.level || '');
      }

      // Location type multi-select
      if (show && activeLocationTypes.size > 0) {
        show = activeLocationTypes.has(el.dataset.locationType || '');
      }

      // Location dropdown
      if (show && activeLocation) {
        show = el.dataset.location === activeLocation;
      }

      // Search
      if (show && searchQuery) {
        show = (el.dataset.search || '').includes(searchQuery);
      }

      el.style.display = show ? '' : 'none';
      el.classList.remove('last-visible');
      if (show) { visible++; lastVisible = el; }
    });

    // Remove bottom border from last visible row
    if (lastVisible) lastVisible.classList.add('last-visible');

    if (noResults) noResults.classList.toggle('hidden', visible > 0);
    if (visibleCount) visibleCount.textContent = String(visible);
  }

  searchInput?.addEventListener('input', () => {
    searchQuery = searchInput.value.toLowerCase().trim();
    searchClear?.classList.toggle('hidden', !searchQuery);
    applyFilters();
    saveFilters();
  });

  document.getElementById('clear-all-filters')?.addEventListener('click', () => {
    if (searchInput) searchInput.value = '';
    if (locationSelect) locationSelect.value = '';
    searchQuery = '';
    activeLocation = '';
    activeLevels.clear();
    activeLocationTypes.clear();
    checkboxes.forEach(cb => cb.checked = false);
    searchClear?.classList.add('hidden');
    updatePills();
    applyFilters();
    saveFilters();
  });

  searchClear?.addEventListener('click', () => {
    if (searchInput) searchInput.value = '';
    searchQuery = '';
    searchClear.classList.add('hidden');
    applyFilters();
    saveFilters();
  });

  locationSelect?.addEventListener('change', () => {
    activeLocation = locationSelect.value;
    applyFilters();
    saveFilters();
  });
</script>
