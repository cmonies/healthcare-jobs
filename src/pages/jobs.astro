---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import JobCard from '../components/JobCard.astro';
import Newsletter from '../components/Newsletter.astro';
import jobs from '../data/jobs.json';

const levels = [...new Set(jobs.map(j => j.level))];
const locationTypes = [...new Set(jobs.map(j => j.locationType))];

const levelCounts: Record<string, number> = {};
levels.forEach(l => { levelCounts[l] = jobs.filter(j => j.level === l).length; });
const locationCounts: Record<string, number> = {};
locationTypes.forEach(lt => { locationCounts[lt] = jobs.filter(j => j.locationType === lt).length; });
---

<Layout title="All Jobs ‚Äî designwith.care">
  <Header />

  <section class="w-full lg:w-[70%] 2xl:w-[60%] mx-auto px-6 pt-12 pb-6">
    <h1 class="animate-fade-up stagger-1 text-3xl font-bold text-gray-900 dark:text-white mb-2">All jobs</h1>
    <p class="animate-fade-up stagger-2 text-base text-gray-500 dark:text-gray-400"><span id="visible-count">{jobs.length}</span> healthcare UX roles from companies that care</p>
  </section>

  <!-- Search -->
  <section class="w-full lg:w-[70%] 2xl:w-[60%] mx-auto px-6 pb-4">
    <div class="animate-fade-up stagger-3 relative max-w-2xl">
      <svg class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
        <circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" />
      </svg>
      <input
        id="search-input"
        type="text"
        placeholder="Search by title, company, or tag..."
        class="w-full pl-11 pr-4 py-3 rounded-xl border border-creme-300/60 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:border-sapphire-300 dark:focus:border-sapphire-700 focus:ring-2 focus:ring-sapphire-100 dark:focus:ring-sapphire-900/50 transition-[border-color,box-shadow] duration-150"
      />
    </div>
  </section>

  <!-- Filters -->
  <section class="w-full lg:w-[70%] 2xl:w-[60%] mx-auto px-6 pb-8">
    <div class="animate-fade-up stagger-4 flex flex-wrap gap-2" id="filters">
      <button class="filter-btn active" data-filter="all">
        All <span class="filter-count">{jobs.length}</span>
      </button>
      {levels.map(level => (
        <button class="filter-btn" data-filter={`level:${level}`}>
          {level} <span class="filter-count">{levelCounts[level]}</span>
        </button>
      ))}
      <span class="border-l border-gray-200 mx-1 hidden sm:block"></span>
      {locationTypes.map(lt => (
        <button class="filter-btn" data-filter={`location:${lt}`}>
          {lt === 'Remote' ? 'üåç ' : lt === 'Hybrid' ? 'üè¢ ' : 'üìç '}{lt} <span class="filter-count">{locationCounts[lt]}</span>
        </button>
      ))}
    </div>
  </section>

  <!-- Jobs List -->
  <section class="w-full lg:w-[70%] 2xl:w-[60%] mx-auto px-6 pb-20">
    <div class="grid gap-3" id="jobs-list">
      {jobs.map(job => (
        <div
          class="job-item"
          data-level={job.level}
          data-location-type={job.locationType}
          data-search={`${job.title} ${job.company} ${job.tags.join(' ')}`.toLowerCase()}
        >
          <JobCard {...job} />
        </div>
      ))}
    </div>
    <p id="no-results" class="text-center text-gray-400 py-12 hidden">
      No jobs match your search. Try different keywords or filters!
    </p>
  </section>

  <!-- Newsletter -->
  <section class="w-full lg:w-[70%] 2xl:w-[60%] mx-auto px-6 pb-10">
    <Newsletter />
  </section>

  <Footer />
</Layout>

<style>
  .filter-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 500;
    border: 1px solid #e5e7eb;
    color: #6b7280;
    background: white;
    transition: all 0.15s;
    cursor: pointer;
  }
  :global(.dark) .filter-btn {
    border-color: #374151;
    color: #9ca3af;
    background: #111827;
  }
  .filter-btn:hover {
    border-color: #D4E0F5;
    color: #0F52BA;
  }
  :global(.dark) .filter-btn:hover {
    border-color: #1e3a5f;
  }
  .filter-btn.active {
    background: #0F52BA;
    border-color: #0F52BA;
    color: white;
  }
  .filter-count {
    font-size: 0.75rem;
    opacity: 0.7;
  }
</style>

<script>
  const buttons = document.querySelectorAll('.filter-btn');
  const items = document.querySelectorAll('.job-item');
  const noResults = document.getElementById('no-results');
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const visibleCount = document.getElementById('visible-count');

  let activeFilter = 'all';
  let searchQuery = '';

  function applyFilters() {
    let visible = 0;
    items.forEach(item => {
      const el = item as HTMLElement;
      let show = true;

      // Filter
      if (activeFilter !== 'all') {
        if (activeFilter.startsWith('level:')) {
          show = el.dataset.level === activeFilter.split(':')[1];
        } else if (activeFilter.startsWith('location:')) {
          show = el.dataset.locationType === activeFilter.split(':')[1];
        }
      }

      // Search
      if (show && searchQuery) {
        show = (el.dataset.search || '').includes(searchQuery);
      }

      el.style.display = show ? '' : 'none';
      if (show) visible++;
    });

    if (noResults) {
      noResults.classList.toggle('hidden', visible > 0);
    }
    if (visibleCount) {
      visibleCount.textContent = String(visible);
    }
  }

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      buttons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      activeFilter = btn.getAttribute('data-filter') || 'all';
      applyFilters();
    });
  });

  searchInput?.addEventListener('input', () => {
    searchQuery = searchInput.value.toLowerCase().trim();
    applyFilters();
  });
</script>
